<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LRD 1024 bytes 2023</title>
</head>

<body>
  <script>
    // emulate the js1k shim
    const d = document
    const b = d.body

    let a = d.createElement('canvas')
    let c = a.getContext('2d')

    b.append(a)

    a.width = innerWidth
    a.height = innerHeight
  </script>


  <script>
    // nb later on when golfing consider packing these into a single string and
    // see if regpack likes that - sometimes it prefers separate consts or inline
    // literals
    //
    // stat related
    const $ = '💰'
    const weapon = '🗡️'
    const shield = '🛡️'
    const rogue = '🍀'
    const fighter = '💪'
    const magic = '🔮'
    // locations
    const castle = '🏰'
    const shop = '🏪'
    const healer = '🏥'
    const forest = '🌲'
    // boss
    const dragon = '🐉'

    // hang loose
    const rad = '🤙'
    // normal monsters
    //
    // level 1
    const bat = '🦇'
    const rat = '🐀'
    const snake = '🐍'
    // level 2
    const clown = '🤡'
    const goblin = '👺'
    const spider = '🕷️'
    // level 3
    const wolf = '🐺'
    const ghost = '👻'
    const skeleton = '💀'
    // level 4
    const troll = '👹'
    const devil = '😈'
    const bear = '🐻'
    // level 5
    const zombie = '🧟'
    const cyclops = '👁️'
    const alien = '👾'
    // encounters, good luck
    const unicorn = '🦄'
    const fairy = '🧚'
    const rainbow = '🌈'
    // encounters, bad luck
    const web = '🕸️'
    const trap = '🕳️'
    const vampire = '🧛'
    // concepts
    const health = '❤️'
    const attack = '⚔️'
    const dead = '☠️'
    const win = '🏆'
    const look = '👀'
    const visit = '💨'
    const nope = '🔒'
    const decision = '🤔'
    const place = '🗺️'
    const lucky = '🍀'
    const unlucky = '😭'
    const time = '⏰'
    const level = '🎚️'
    const up = '👆'
    const gym = '🏋️'
    const dice = '🎲'
    const ws = ' '

    // shop prices, levels, etc - all use this for scaling - will need tweaking
    const scaling = [0, 128, 512, 1024, 4096, 16384]

    // player stats etc
    /*
    -=-=-
    🔮 💰51 ⚔️9 ❤️12/19 🗡️1 🛡️1 🎚️2/11200 ☝️3/10000
    -=-=-
    pclass p$ patk php phpmax pweapon pshield plevel pexp
    */

    let pclass
    let p$
    let patk
    let php
    let phpmax
    let pweapon
    let pshield
    let plevel
    let pexp
    let pturns

    let plocation

    // forest encounter state
    // monster emoji
    let fclass
    // reward $ and xp
    let f$
    let fexp
    // monster atk
    let fatk
    // monster hp
    let fhp
    // monster dmg - for player it's plevel + 1 + pweapon, for monster just a num
    let fdmg

    // output
    let cline // current line
    let line0
    let line1
    let line2
    let line3
    let line4
    let line5
    let line6 // i think that's all we need

    // dice
    let die0
    let die1
    let die2

    // temp
    let tmpValue0
    let tmpLocked0

    const tick = () => {
      line0 = line1 = line2 = line3 = line4 = line5 = line6 = 0

      // rogues are luckier - they have a chance to reroll 1s
      // therefore, 1 or a low value should always be bad, and high values
      // should always be good
      die0 = ((Math.random() * 6) | 0) + 1
      die1 = ((Math.random() * 6) | 0) + 1
      die2 = ((Math.random() * 6) | 0) + 1
      if (pclass === lucky && die0 == 1) die0 = ((Math.random() * 6) | 0) + 1
      if (pclass === lucky && die1 == 1) die1 = ((Math.random() * 6) | 0) + 1
      if (pclass === lucky && die2 == 1) die2 = ((Math.random() * 6) | 0) + 1

      a.remove()
      a = d.createElement('pre')
      b.append(a)

      c = d.createElement('pre')
      c.append(plocation + ws + lucky + dragon + 1024)

      a.append(c)

      if (plocation == decision) {
        // init player
        pclass = decision
        p$ = 128
        // we have 6 points to spend, health only cost 0.5, eg we get 2 per point
        patk = 4
        php = phpmax = 8
        patk = patk + die0 // assign die0 to attack
        php = phpmax = php + (6 - die0) * 2 // assign the rest to health
        pweapon = 0
        pshield = 0
        plevel = 1
        pexp = 0
        pturns = 0

        // set the lines to class choices
        line0 = decision

        // reroll
        cline = d.createElement('button')
        cline.onclick = () => {
          plocation = decision
          tick()
        }
        // button label
        cline.append(dice)
        // suffix
        c = d.createElement('b')
        c.append(cline, die0)
        line1 = c

        // choose rogue
        cline = d.createElement('button')
        cline.onclick = () => {
          pclass = rogue

          plocation = castle
          tick()
        }
        cline.append(lucky)
        // trick to allow a suffix outside link
        c = d.createElement('b')
        c.append(cline, dice + lucky)
        line2 = c

        // choose fighter
        cline = d.createElement('button')
        cline.onclick = () => {
          pclass = fighter
          patk = patk + 1

          plocation = castle
          tick()
        }
        cline.append(fighter)
        // trick to allow a suffix outside link
        c = d.createElement('b')
        c.append(cline, attack, patk + 1)
        line3 = c

        // choose magic
        cline = d.createElement('button')
        cline.onclick = () => {
          pclass = magic
          php = phpmax = phpmax + 2

          plocation = castle
          tick()
        }
        cline.append(magic)
        // trick to allow a suffix outside link
        c = d.createElement('b')
        c.append(cline, health, phpmax + 2)
        line4 = c
      }
      // these are exclusive anyway so check if removing else is better for regpack later
      else if (plocation == castle) {
        // do castle stuff 

        line0 = decision

        // weapon shop
        // can buy if not max and if have money

        cline = d.createElement('button')
        cline.onclick = () => {
          if (!(pweapon == 5 || p$ < scaling[pweapon + 1])) {
            // begin custom shop action
            p$ = p$ - scaling[pweapon + 1]
            pweapon = pweapon + 1
            patk = patk + 1
            // end custom shop action

            plocation = castle
            tick()
          }
        }
        // button label
        cline.append(weapon + '+', pweapon + 1)
        // suffix - after and outside button
        c = d.createElement('b')
        c.append(
          cline,
          pweapon == 5 || p$ < scaling[pweapon + 1] ?
            pweapon == 5 ?
              nope + weapon :
              nope + $ + scaling[pweapon + 1] :
            $ + scaling[pweapon + 1]
        )
        line1 = c

        // shield shop
        // can buy if not max and if have money
        cline = d.createElement('button')
        cline.onclick = () => {
          if (!(pshield == 5 || p$ < scaling[pshield + 1])) {
            // begin custom shop action
            p$ = p$ - scaling[pshield + 1]
            pshield = pshield + 1
            phpmax = phpmax + 2
            php = php + 2
            // end custom shop action

            plocation = castle
            tick()
          }
        }
        // button label
        cline.append(shield + '+', pshield + 1)
        // suffix - after and outside button
        c = d.createElement('b')
        c.append(
          cline,
          pshield == 5 || p$ < scaling[pshield + 1] ?
            pshield == 5 ?
              nope + shield :
              nope + $ + scaling[pshield + 1] :
            $ + scaling[pshield + 1]
        )

        line2 = c

        // healer
        cline = d.createElement('button')
        cline.onclick = () => {
          if (!(p$ < 5 || php == phpmax)) {
            // begin custom shop action
            p$ = p$ - 5
            php = php + 1
            // end custom shop action

            plocation = castle
            tick()
          }
        }
        // button label
        cline.append(health + '+1')
        // suffix - after and outside button
        c = d.createElement('b')
        c.append(
          cline,
          php == phpmax ? nope + health + health : p$ < 5 ? nope + $ + 5 : $ + 5
        )
        line3 = c

        // gym
        cline = d.createElement('button')
        // doesn't go anywhere, just checks if they can level up and if so
        // does the action and reloads castle
        cline.onclick = () => {
          if (!(pexp < scaling[plevel])) {
            // begin custom shop action
            plevel = plevel + 1
            patk = patk + 1
            php = phpmax = phpmax + 2
            // end custom shop action

            plocation = castle
            tick()
          }
        }
        // button label
        cline.append(level, plevel + 1)
        c = d.createElement('b')
        c.append(
          cline,
          pexp < scaling[plevel] ? nope + scaling[plevel] : up + scaling[plevel]
        )
        line4 = c

        // forest
        cline = d.createElement('button')
        cline.onclick = () => {
          plocation = forest
          tick()
        }
        cline.append(forest)
        line5 = cline
      }
      else if (plocation == forest) {
        line0 = decision

        // explore
        cline = d.createElement('button')
        cline.onclick = () => {
          plocation = look
          tick()
        }
        cline.append(look)
        line1 = cline

        // look for dragon - locked until plevel == 5
        cline = d.createElement('button')
        cline.onclick = () => {
          if (plevel == 5) {
            plocation = dragon
            tick()
          }
        }
        // button label
        cline.append(dragon)
        // suffix - after and outside button
        c = d.createElement('b')
        c.append(
          cline,
          plevel == 5 ? look : nope + level + 5
        )
        line2 = c

        // back to castle
        cline = d.createElement('button')
        cline.onclick = () => {
          plocation = castle
          tick()
        }
        cline.append(castle)
        line3 = cline
      }
      else if (plocation == look) {
        // if die0 == die1, random event
        // else, setup a battle and go to it

        c = d.createElement('b')
        c.append(dice + die0 + dice + die1)
        line0 = c
        
        if (die0 == die1) {
          // super bad - vampire
          if (die0 == 1) {
            c = d.createElement('b')
            c.append(unlucky + vampire)
            line1 = c

            // terrible - lost MAX HP
            if (die2 == 1) {
              // draw message, take MAX HP and HP
              phpmax = phpmax - plevel + 1
              php = php - plevel + 1

              c = d.createElement('b')
              c.append(dice + die2 + health + '-', plevel + 1, '/-', plevel + 1)
              line2 = c
            }
            // bad - lose HP 
            else {
              // draw message, take HP
              php = php - plevel + 1

              c = d.createElement('b')
              c.append(dice + die2 + health + '-', plevel + 1 )
              line2 = c
            }
          }
          // bad
          else if (die0 == 2) {
            // money fell down hole, lose some $
            // max can lose is 3 * die2 * plevel
            // invert die2 so that if eg rogue, less likely to be 6x
            die2 = 6 - die2
            tmpValue0 = 3 * die2 * plevel
            tmpValue0 = tmpValue0 > p$ ? p$ : tmpValue0

            p$ = p$ - tmpValue0
            c = d.createElement('b')
            c.append(unlucky + trap)
            line1 = c

            c = d.createElement('b')
            c.append(dice + die2 + $ + '-' + tmpValue0)
            line2 = c
          }
          // bad
          else if (die0 == 3) {
            // got stuck in spider web, lose HP
            // draw message, take HP

            php = php - plevel

            c = d.createElement('b')
            c.append(unlucky + web)
            line1 = c

            c = d.createElement('b')
            c.append(health + '-' + plevel)
            line2 = c
          }
          // good
          else if (die0 == 4) {
            // fairy - get die2 HP, even over max
            // draw message, give HP

            php = php + die2 * plevel

            c = d.createElement('b')
            c.append(lucky + fairy)
            line1 = c

            c = d.createElement('b')
            c.append(dice + die2 + health + '+' + die2)
            line2 = c
          }
          // good
          else if (die0 == 5) {
            // rainbow = get some $
            // draw message, give $, link back to forest
            tmpValue0 = (die2 * scaling[plevel] / 10) | 0
            p$ = p$ + tmpValue0

            c = d.createElement('b')
            c.append(lucky + rainbow)
            line1 = c

            c = d.createElement('b')
            c.append(dice + die2 + $ + tmpValue0)
            line2 = c
          }
          // super good
          else if (die0 == 6) {
            tmpValue0 = (die2 * scaling[plevel] / 10) | 0

            c = d.createElement('b')
            c.append(lucky + unicorn)
            line1 = c

            // unicorn - get lots of stuff
            // amazing - get some ATK, some MAX HP
            c = d.createElement('b')
            if (die2 == 6) {
              // draw message, give ATK, give MAX HP
              patk = patk + 1
              phpmax = phpmax + 2
              // 10 * the money
              tmpValue0 = die2 * scaling[plevel]

              c.append(dice + die2 + ws + $ + tmpValue0 + ws + attack + '+1' + ws + health + '+2/+2' + ws + health + health)
            }
            else {
              c.append(dice + die2 + ws + $ + tmpValue0 + ws + health + health)
            }
            line2 = c

            p$ = p$ + tmpValue0
            php = phpmax
          }

          // handle if the event killed player
          if (php <= 0) {
            cline = d.createElement('button')
            cline.onclick = () => {
              plocation = dead
              tick()
            }
            cline.append(dead)
            line6 = cline
          }
          else {
            // back to forest - assume line6 is available
            // back to castle
            cline = d.createElement('button')
            cline.onclick = () => {
              plocation = forest
              tick()
            }
            cline.append(forest)
            line6 = cline
          }
        }
        else {
          // todo battle
          // choose a monster based on plevel and dice          

          // setup monster

          // create battle link, and run if allowed
          // fighters can't run, mages depend on dice roll, rogues can always

          // if use die0 to choose monster, use die1 to choose if can run

          // TEMP until code is here so we can get out
          // back to forest - assume line6 is available
          cline = d.createElement('button')
          cline.onclick = () => {
            plocation = forest
            tick()
          }
          cline.append(forest)
          line6 = cline
        }
      }
      else if (plocation == dragon) {
        // same as attack, maybe there is a redirect pattern we can use after 
        // we set up battle?
      }
      else if (plocation == attack) {
        // todo - we have a monster and we are attacking it
        // but maybe it has 0 hp now, or we have 0 hp and are dead
        // handle if the monster killed player
      }
      else if (plocation == dead) {
        a.append(dead + dead + dead)
        // no outbound links, sorry, game over!
      }
      else if (plocation == win) {
        a.append(win + win + win)
        // no outbound links, sorry, game over!        
      }

      // draw the lines - check if a an array and for loop is cheaper in regpack later      
      if (line0) {
        a.append(line0, '\n')
      }
      // next
      if (line1) {
        a.append(line1, '\n')
      }
      // next
      if (line2) {
        a.append(line2, '\n')
      }
      // next
      if (line3) {
        a.append(line3, '\n')
      }
      // next
      if (line4) {
        a.append(line4, '\n')
      }
      // next
      if (line5) {
        a.append(line5, '\n')
      }
      // next
      if (line6) {
        a.append(line6, '\n')
      }


      // last, draw stats
      /*
      🍀 💰10 ⚔️7 ❤️18/18 🗡️0 🛡️0 🎚️1/0 🔒2/128 ⏰17
      */
      c = d.createElement('pre')
      c.append(
        pclass + ws +
        $ + p$ + ws +
        attack + patk + ws +
        health + php + '/' + phpmax + ws +
        weapon + pweapon + ws +
        shield + pshield + ws,
        level + plevel + '/' + pexp,
        pexp >= scaling[plevel] ? up : '',
        // we will just show current level xp for now, we are going to 
        // simplify it
        //nope + pturns + '/' + scaling[plocation - 1] + ws +
        ws + time + pturns
      )
      a.append(c)

      pturns = pturns + 1
    }
    plocation = decision
    tick()
  </script>
</body>

</html>