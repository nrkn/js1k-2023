<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LRD 1024 bytes 2023</title>
</head>

<body>
  <script>
    // emulate the js1k shim
    const d = document
    const b = d.body

    let a = d.createElement('canvas')
    let c = a.getContext('2d')

    b.append(a)

    a.width = innerWidth
    a.height = innerHeight
  </script>

  <script>
    // nb later on when golfing consider packing these into a single string and
    // see if regpack likes that - sometimes it prefers separate consts or inline
    // literals
    //
    // stat related
    const $ = 'üí∞'
    const weapon = 'üó°Ô∏è'
    const shield = 'üõ°Ô∏è'
    const rogue = 'üçÄ'
    const fighter = 'üí™'
    const magic = 'üîÆ'
    // locations
    const castle = 'üè∞'
    const shop = 'üè™'
    const healer = 'üè•'
    const forest = 'üå≤'
    // boss
    const dragon = 'üêâ'

    // hang loose
    const rad = 'ü§ô'
    // normal monsters
    //
    // level 1
    const bat = 'ü¶á'
    const rat = 'üêÄ'
    const snake = 'üêç'
    // level 2
    const clown = 'ü§°'
    const goblin = 'üë∫'
    const spider = 'üï∑Ô∏è'
    // level 3
    const wolf = 'üê∫'
    const ghost = 'üëª'
    const skeleton = 'üíÄ'
    // level 4
    const troll = 'üëπ'
    const devil = 'üòà'
    const bear = 'üêª'
    // level 5
    const zombie = 'üßü'
    const cyclops = 'üëÅÔ∏è'
    const alien = 'üëæ'
    // encounters, good luck
    const unicorn = 'ü¶Ñ'
    const fairy = 'üßö'
    const rainbow = 'üåà'
    // encounters, bad luck
    const web = 'üï∏Ô∏è'
    const trap = 'üï≥Ô∏è'
    const vampire = 'üßõ'
    // concepts
    const health = '‚ù§Ô∏è'
    const attack = '‚öîÔ∏è'
    const dead = '‚ò†Ô∏è'
    const win = 'üèÜ'
    const look = 'üëÄ'
    const visit = 'üí®'
    const nope = 'üîí'
    const decision = 'ü§î'
    const place = 'üó∫Ô∏è'
    const lucky = 'üçÄ'
    const unlucky = 'üò≠'
    const time = '‚è∞'
    const level = 'üéöÔ∏è'
    const up = 'üëÜ'
    const gym = 'üèãÔ∏è'
    const dice = 'üé≤'
    const ws = ' '

    // shop prices, levels, etc - all use this for scaling - will need tweaking
    const scaling = [0, 128, 512, 1024, 4096, 16384, 33768]

    // player stats etc
    /*
    -=-=-
    üîÆ üí∞51 ‚öîÔ∏è9 ‚ù§Ô∏è12/19 üó°Ô∏è1 üõ°Ô∏è1 üéöÔ∏è2/11200 ‚òùÔ∏è3/10000
    -=-=-
    pclass p$ patk php phpmax pweapon pshield plevel pexp
    */

    let pclass
    let p$
    let patk
    let php
    let phpmax
    let pweapon
    let pshield
    let plevel
    let pexp
    let pturns

    let plocation

    // forest encounter state
    // monster emoji
    let fclass
    // reward $ and xp
    let f$
    let fexp
    // monster atk
    let fatk
    // monster hp
    let fhp
    // monster dmg - for player it's plevel + 1 + pweapon, for monster just a num
    let fdmg

    // output
    let cline // current line

    // dice
    let die0
    let die1
    let die2

    // temp
    let tmpValue0
    let tmpLocked0

    const tick = () => {
      // rogues are luckier - they have a chance to reroll 1s
      // therefore, 1 or a low value should always be bad, and high values
      // should always be good
      die0 = ((Math.random() * 6) | 0) + 1
      die1 = ((Math.random() * 6) | 0) + 1
      die2 = ((Math.random() * 6) | 0) + 1
      if (pclass === lucky && die0 == 1) die0 = ((Math.random() * 6) | 0) + 1
      // don't reroll the enemy dice, jebus!
      if (pclass === lucky && die1 == 1 && plocation != attack) die1 = ((Math.random() * 6) | 0) + 1
      if (pclass === lucky && die2 == 1) die2 = ((Math.random() * 6) | 0) + 1

      // cls (and in first tick, remove the canvas)
      a.remove()
      a = d.createElement('pre')
      b.append(a)

      // location + title
      a.append(plocation + ws + lucky + dragon + 1024, '\n')

      // where are we?
      if (plocation == decision) {
        // init player
        pclass = decision
        p$ = 25
        patk = 5
        php = phpmax = 10
        pweapon = 0
        pshield = 0
        plevel = 0
        pexp = 0
        pturns = 0


        a.append(decision, '\n')

        // choose rogue
        cline = d.createElement('button')
        cline.onclick = () => {
          pclass = rogue

          plocation = castle
          tick()
        }
        //button
        cline.append(lucky)
        a.append(
          //button
          cline,
          //suffix
          dice + lucky, '\n'
        )

        // choose fighter
        cline = d.createElement('button')
        cline.onclick = () => {
          pclass = fighter
          patk = patk + 1

          plocation = castle
          tick()
        }
        cline.append(fighter)
        a.append(
          //button
          cline,
          //suffix
          attack, patk + 1, '\n'
        )

        // choose magic
        cline = d.createElement('button')
        cline.onclick = () => {
          pclass = magic
          php = phpmax = phpmax + 2

          plocation = castle
          tick()
        }
        cline.append(magic)
        a.append(
          //button
          cline,
          //suffix
          health, phpmax + 2, '\n'
        )
      }
      // these are exclusive anyway so check if removing else is better for regpack later
      else if (plocation == castle) {
        // do castle stuff 

        a.append(decision, '\n')

        // weapon shop
        // can buy if not max and if have money
        cline = d.createElement('button')
        cline.onclick = () => {
          if (!(pweapon == 5 || p$ < scaling[pweapon + 1])) {
            // begin custom shop action
            p$ = p$ - scaling[pweapon + 1]
            pweapon = pweapon + 1
            patk = patk + 1
            // end custom shop action

            plocation = castle
            tick()
          }
        }
        // button label
        cline.append(weapon + '+', pweapon + 1)

        a.append(
          cline,
          // suffix - after and outside button
          pweapon == 5 || p$ < scaling[pweapon + 1] ?
            pweapon == 5 ?
              nope + weapon :
              nope + $ + scaling[pweapon + 1] :
            $ + scaling[pweapon + 1],
          '\n'
        )

        // shield shop
        // can buy if not max and if have money
        cline = d.createElement('button')
        cline.onclick = () => {
          if (!(pshield == 5 || p$ < scaling[pshield + 1])) {
            // begin custom shop action
            p$ = p$ - scaling[pshield + 1]
            pshield = pshield + 1
            phpmax = phpmax + 2
            php = php + 2
            // end custom shop action

            plocation = castle
            tick()
          }
        }
        // button label
        cline.append(shield + '+', pshield + 1)
        a.append(
          cline,
          // suffix - after and outside button
          pshield == 5 || p$ < scaling[pshield + 1] ?
            pshield == 5 ?
              nope + shield :
              nope + $ + scaling[pshield + 1] :
            $ + scaling[pshield + 1],
          '\n'
        )

        // healer
        cline = d.createElement('button')
        cline.onclick = () => {
          if (!(p$ < 5 || php == phpmax)) {
            // begin custom shop action
            p$ = p$ - 5
            php = php + 1
            // end custom shop action

            plocation = castle
            tick()
          }
        }
        // button label
        cline.append(health + '+1')
        a.append(
          cline,
          // suffix - after and outside button
          php == phpmax ? nope + health + health : p$ < 5 ? nope + $ + 5 : $ + 5,
          '\n'
        )

        // gym
        tmpLocked0 = plevel == 5
        cline = d.createElement('button')
        // doesn't go anywhere, just checks if they can level up and if so
        // does the action and reloads castle
        cline.onclick = () => {
          if (!tmpLocked0 && !(pexp < scaling[plevel + 1])) {
            // begin custom shop action
            plevel = plevel + 1
            patk = patk + 1
            php = phpmax = phpmax + 2
            // end custom shop action

            plocation = castle
            tick()
          }
        }
        // button label
        cline.append(level, plevel + 1)
        a.append(
          cline,
          tmpLocked0 ? nope :
            pexp < scaling[plevel + 1] ? nope + scaling[plevel + 1] : up + scaling[plevel + 1],
          '\n'
        )

        // forest
        cline = d.createElement('button')
        cline.onclick = () => {
          plocation = forest
          tick()
        }
        cline.append(forest)
        a.append(cline, '\n')
      }
      else if (plocation == forest) {
        a.append(decision, '\n')

        // explore
        cline = d.createElement('button')
        cline.onclick = () => {
          plocation = look
          tick()
        }
        cline.append(look)
        a.append(cline, '\n')

        // look for dragon - locked until plevel == 5
        cline = d.createElement('button')
        cline.onclick = () => {
          if (plevel == 5) {
            fclass = dragon
            f$ = scaling[plevel] * 2
            fexp = scaling[plevel] * 2
            fatk = 14
            fhp = 50
            fdmg = 4 + plevel // 2 at level 0            

            plocation = attack
            tick()
          }
        }
        // button label
        cline.append(dragon)
        a.append(
          cline,
          // suffix - after and outside button
          plevel == 5 ? look : nope + level + 5,
          '\n'
        )

        // back to castle
        cline = d.createElement('button')
        cline.onclick = () => {
          plocation = castle
          tick()
        }
        cline.append(castle)
        a.append(cline, '\n')
      }
      else if (plocation == look) {
        // if die0 == die1, random event
        // else, setup a battle and go to it

        a.append(dice + die0 + dice + die1, '\n')

        if (die0 == die1) {
          // super bad - vampire
          if (die0 == 1) {
            a.append(unlucky + vampire, '\n')


            // terrible - lost MAX HP
            if (die2 == 1) {
              // draw message, take MAX HP and HP
              phpmax = phpmax - (plevel + 1)
              php = php - (plevel + 1)

              a.append(dice + die2 + health + '-', plevel + 1, '/-', plevel + 1, '\n')
            }
            // bad - lose HP 
            else {
              // draw message, take HP
              php = php - (plevel + 1)

              a.append(dice + die2 + health + '-', plevel + 1, '\n')
            }
          }
          // bad
          else if (die0 == 2) {
            // money fell down hole, lose some $
            // max can lose is 3 * die2 * plevel
            // invert die2 so that if eg rogue, less likely to be 6x
            die2 = 7 - die2
            tmpValue0 = 3 * die2 * (plevel + 1)
            tmpValue0 = tmpValue0 > p$ ? p$ : tmpValue0

            p$ = p$ - tmpValue0

            a.append(
              unlucky + trap, '\n',
              dice + die2 + $ + '-' + tmpValue0, '\n'
            )
          }
          // bad
          else if (die0 == 3) {
            // got stuck in spider web, lose HP
            // draw message, take HP

            php = php - (plevel + 1)

            a.append(
              unlucky + web, '\n',
              health + '-' + (plevel + 1), '\n'
            )
          }
          // good
          else if (die0 == 4) {
            // fairy - get die2 HP, even over max
            // draw message, give HP

            php = php + die2 * (plevel + 1)

            a.append(
              lucky + fairy, '\n',
              dice + die2 + health + '+' + die2, '\n'
            )
          }
          // good
          else if (die0 == 5) {
            // rainbow = get some $
            // draw message, give $, link back to forest
            tmpValue0 = (die2 * scaling[plevel + 1] / 10) | 0
            p$ = p$ + tmpValue0

            a.append(
              lucky + rainbow, '\n',
              dice + die2 + $ + tmpValue0, '\n'
            )
          }
          // super good
          else if (die0 == 6) {
            tmpValue0 = (die2 * scaling[plevel + 1] / 10) | 0

            // c = d.createElement('b')
            // c.append(lucky + unicorn)
            // line1 = c
            a.append(lucky + unicorn, '\n')

            // unicorn - get lots of stuff
            // amazing - get some ATK, some MAX HP
            //c = d.createElement('b')
            if (die2 == 6) {
              // draw message, give ATK, give MAX HP
              patk = patk + 1
              phpmax = phpmax + 2
              // 10 * the money
              tmpValue0 = die2 * scaling[plevel + 1]

              a.append(
                dice + die2 + ws +
                $ + tmpValue0 + ws +
                attack + '+1' + ws +
                health + '+2/+2' + ws +
                health + health,
                '\n'
              )
            }
            else {
              a.append(
                dice + die2 + ws +
                $ + tmpValue0 + ws +
                health + health,
                '\n'
              )
            }

            p$ = p$ + tmpValue0
            php = phpmax
          }

          // handle if the event killed player
          if (php <= 0) {
            cline = d.createElement('button')
            cline.onclick = () => {
              plocation = dead
              tick()
            }
            cline.append(dead)
            a.append(cline, '\n')
          }
          else {
            // back to forest - assume line6 is available
            // back to castle
            cline = d.createElement('button')
            cline.onclick = () => {
              plocation = forest
              tick()
            }
            cline.append(forest)
            a.append(cline, '\n')
          }
        }
        else {
          // todo battle
          /*
            // level 1
            const bat = 'ü¶á'
            const rat = 'üêÄ'
            const snake = 'üêç'
            // level 2
            const clown = 'ü§°'
            const goblin = 'üë∫'
            const spider = 'üï∑Ô∏è'
            // level 3
            const wolf = 'üê∫'
            const ghost = 'üëª'
            const skeleton = 'üíÄ'
            // level 4
            const troll = 'üëπ'
            const devil = 'üòà'
            const bear = 'üêª'
            // level 5
            const zombie = 'üßü'
            const cyclops = 'üëÅÔ∏è'
            const alien = 'üëæ'          
          */
          // choose a monster based on plevel and dice  
          if (plevel == 0 && die0 < 3) {
            fclass = bat
          }
          else if (plevel == 0 && die0 < 5) {
            fclass = rat
          }
          else if (plevel == 0) {
            fclass = snake
          }
          else if (plevel == 1 && die0 < 3) {
            fclass = clown
          }
          else if (plevel == 1 && die0 < 5) {
            fclass = goblin
          }
          else if (plevel == 1) {
            fclass = spider
          }
          else if (plevel == 2 && die0 < 3) {
            fclass = wolf
          }
          else if (plevel == 2 && die0 < 5) {
            fclass = ghost
          }
          else if (plevel == 2) {
            fclass = skeleton
          }
          else if (plevel == 3 && die0 < 3) {
            fclass = troll
          }
          else if (plevel == 3 && die0 < 5) {
            fclass = devil
          }
          else if (plevel == 3) {
            fclass = bear
          }
          else if (die0 < 3) {
            fclass = zombie
          }
          else if (die0 < 5) {
            fclass = cyclops
          }
          else {
            fclass = alien
          }

          // setup monster - we've used die0 and die1, leave die2 for mage run
          f$ = ((die0 + die1) * scaling[plevel + 1] / 100) | 0
          fexp = ((die1 + die2) * scaling[plevel + 1] / 100) | 0
          fatk = (7 - die1) + plevel
          fhp = ((7 - die0) + plevel) * 2
          fdmg = 2 + plevel

          // display monster
          a.append(
            fclass + ws + attack + fatk + ws + health + fhp, '\n',

            decision, '\n'
          )

          // attack
          cline = d.createElement('button')
          cline.onclick = () => {
            plocation = attack
            tick()
          }
          cline.append(attack)
          a.append(cline, '\n')

          // can always run here - it's in attack that we check pclass
          // back to forest
          cline = d.createElement('button')
          cline.onclick = () => {
            fclass = 0
            plocation = forest
            tick()
          }
          cline.append(forest)
          a.append(cline, '\n')
        }
      }
      else if (plocation == attack) {
        // todo: calc and display result of this battle round


        if ((patk + die0) == (fatk + die1)) {
          // no hit      
          // c = d.createElement('b')
          // c.append(shield + shield)
          // line0 = c
          a.append(shield + shield, '\n')
        }
        else if ((patk + die0) > (fatk + die1)) {
          // player hit monster
          tmpValue0 = 2 + pweapon // 2 at level 0      
          fhp = fhp - tmpValue0

          // c = d.createElement('b')
          // c.append(fclass + health + -tmpValue0)
          // line0 = c
          a.append(fclass + health + -tmpValue0, '\n')
        }
        else {
          // monster hit    
          tmpValue0 = fdmg - pshield

          if (tmpValue0 <= 0) {
            // no hit      
            // c = d.createElement('b')
            // c.append(shield + shield)
            // line0 = c
            a.append(shield + shield, '\n')
          }
          else {
            php = php - tmpValue0

            // c = d.createElement('b')
            // c.append(pclass + health + -tmpValue0)
            // line0 = c
            a.append(pclass + health + -tmpValue0, '\n')
          }
        }


        a.append(
          // player
          dice + die0 + ws + pclass + ws + attack + patk + ws + health + php, '\n',

          // monster
          dice + die1 + ws + fclass + ws + attack + fatk + ws + health + fhp, '\n'
        )

        if (php <= 0) {
          // player died
          // c = d.createElement('b')
          // c.append(pclass + dead)
          // line3 = c
          a.append(pclass + dead, '\n')

          // go to dead
          cline = d.createElement('button')
          cline.onclick = () => {
            plocation = dead
            tick()
          }
          cline.append(dead)
          a.append(cline, '\n')
        }
        else if (fhp <= 0) {
          // give rewards
          p$ = p$ + f$
          pexp = pexp + fexp

          a.append(
            // enemy died
            fclass + dead, '\n',

            // show rewards
            $ + f$ + ws + level + fexp, '\n'
          )

          if (fclass == dragon) {
            // exit to win
            cline = d.createElement('button')
            cline.onclick = () => {
              plocation = win
              tick()
            }
            cline.append(win)
            a.append(cline, '\n')
          }
          else {
            // exit to forest
            cline = d.createElement('button')
            cline.onclick = () => {
              fclass = 0
              plocation = forest
              tick()
            }
            cline.append(forest)
            a.append(cline, '\n')
          }
        }
        else {
          // next round, or run if allowed

          //line4 = decision
          a.append(decision, '\n')

          // attack
          cline = d.createElement('button')
          cline.onclick = () => {
            plocation = attack
            tick()
          }
          cline.append(attack)
          //line5 = cline
          a.append(cline, '\n')

          tmpLocked0 = pclass == fighter || pclass == magic && die2 < 4
          tmpValue0 = pclass == fighter ? nope + fighter : tmpLocked0 ? nope + magic + unlucky : pclass == magic ? magic : lucky
          //run, if !tmpLocked0
          cline = d.createElement('button')
          cline.onclick = () => {
            if (!tmpLocked0) {
              fclass = 0
              plocation = forest
              tick()
            }
          }
          // button label
          cline.append(forest)
          // suffix
          a.append(cline, tmpValue0, '\n')
        }
      }
      else if (plocation == dead) {
        a.append(dead + dead + dead, '\n')
        // no outbound links, sorry, game over!
      }
      else if (plocation == win) {
        a.append(win + win + win, '\n')
        // no outbound links, sorry, game over!        
      }

      // last, draw stats
      /*
      üçÄ üí∞10 ‚öîÔ∏è7 ‚ù§Ô∏è18/18 üó°Ô∏è0 üõ°Ô∏è0 üéöÔ∏è1/0 üîí2/128 ‚è∞17
      */
      a.append(
        pclass + ws +
        $ + p$ + ws +
        attack + patk + ws +
        health + php + '/' + phpmax + ws +
        weapon + pweapon + ws +
        shield + pshield + ws,
        level + plevel + '/' + pexp,
        pexp >= scaling[plevel + 1] ? up : '',
        // we will just show current level xp for now, we are going to 
        // simplify it
        //nope + pturns + '/' + scaling[plocation - 1] + ws +
        ws + time + pturns
      )

      pturns = pturns + 1
    }
    plocation = decision
    tick()
  </script>
</body>

</html>